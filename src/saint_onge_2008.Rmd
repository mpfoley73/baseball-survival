---
title: "Reproducing the 2008 Sain Onge, Rogers, and Krueger Study"
author: "Michael Foley"
date: "`r Sys.Date()`"
output: 
  html_document:
    css: "style.css"
    theme: flatly
    toc: true
    toc_float: true
    highlight: haddock
    code_folding: show
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Saint Onge et al. ([2008](#SaintOnge2008)) (the Authors) used professional baseball player data to evaluate the role of anthropomorphic measures (height, body mass, handedness) and performance measures (career length, total player rating) on longevity. Using a discrete time hazards model, the authors found:

* MLB players can expect almost five additional years of life, 
* Height, weight, handedness, and player ratings are not associated with the risk of death, and
* Career length is inversely associated with the risk of death.

This workbook is a reproduction of the analysis using an updated data source.

```{r include=FALSE}
library(tidyverse)
library(lubridate)
library(scales)
library(broom)
library(gtsummary)
library(survival)
```

# Data and Methods

The Authors analyzed data from the electronic version of *Total Baseball* ([2004](#TotalBaseball])). *Total Baseball* was last published in 2008. Instead, I am using the R version of the 2021 edition of Sean Lahman's Baseball Database, the **Lahman** R package v10.0-1 ([2022](#Lahman)).

The Authors restricted their data set to position players who debuted between 1902 and 2004. Pitchers were excluded due to potential differences in career length and selection into MLB. They also excluded players whose career consisted of just a September call-up. That is, they excluded players appearing for a month or less at the end of the season and not not playing the following season.

The Authors do not explain how they defined pitchers. Occasionally a position will pitch in a blowout game to avoid wasting actual pitchers in a lost cause. Also, some players changed positions, the most famous being Babe Ruth. [Ruth pitched](http://www.baberuthcentral.com/babe-ruth-statistics/babes-ruths-full-baseballstatistics/babes-ruths-pitching-stats/) from 1914 - 1919, and a few games in 1920, 1921, 1930, and 1933. I will define pitchers as players who never played any position other than pitcher. That is, I will include players with non-pitching fielding statistics in the **Lahman** Fielding data set.

```{r}
library(Lahman)

data("People", "Fielding", package = "Lahman")

person_0 <- People %>%
  semi_join(Fielding %>% filter(POS != "P"), by = "playerID") %>%
  mutate(
    debut = ymd(debut),
    debutMonth = month(debut),
    debutYear = year(debut),
    finalGame = ymd(finalGame),
    finalGameYear = year(finalGame),
    career_length = time_length(interval(debut, finalGame), "years")
  ) %>%
  filter(
    debutYear >= 1902,
    # September call-ups. I originally filtered debutMonth < 9 (naturally), but
    # my data better aligns with the Authors if I use 8 (August). One confirming
    # evidence came from identifying the youngest player to die. The Authors 
    # report it being Al Montegomery. If I use the < 9 filter, it's Newt Halliday.
    debutMonth < 8 | finalGameYear > debutYear
  )
```

The Authors identify a few players with no death date that would be over 95 years old if alive. They dropped one record as a result. I have six players with no death date that would be over 95. All six are described as living in Wikipedia.

```{r}
person_0 %>% 
  mutate(over95 = 2021 - birthYear >= 95) %>%
  filter(over95, is.na(deathYear)) %>%
  select(nameFirst, nameLast, birthDate)
```

I do have a couple unusual records related to death date though. Alfredo Cabrera and Hector Martinez have no death date because of incomplete month and day information. I can either impute a death date, or drop the record. Since I know at least the year, and in one case the month, I'll keep both records and impute the middle month and/or day.

```{r}
# Two players with incomplete death dates.
person_0 %>% 
  filter(is.na(deathDate), !is.na(deathYear)) %>%
  select(nameFirst, nameLast, birthDate, deathYear, deathMonth, deathDay)

# Impute deathDate if necessary
person_1 <- person_0 %>%
  mutate(deathDate = coalesce(deathDate, 
                              ymd(paste(deathYear,
                                  coalesce(deathMonth, 6), 
                                  coalesce(deathDay, 15)), quiet = TRUE)))
```

There's a similar problem with birth dates. I'll handle them the same way.

```{r}
# Two players with incomplete death dates.
person_1 %>% 
  filter(is.na(birthDate)) %>%
  select(nameFirst, nameLast, birthDate, birthYear, birthMonth, birthDay)

# Impute birthDate if necessary
person_2 <- person_1 %>%
  mutate(birthDate = coalesce(birthDate, 
                              ymd(paste(birthYear,
                                  coalesce(birthMonth, 6), 
                                  coalesce(birthDay, 15)), quiet = TRUE)))
```

The Authors note that the youngest player to die is Al Montgomery. I can confirm that.

```{r}
person_2 %>% 
  mutate(
    all_ages = time_length(interval(birthDate, coalesce(deathDate, ym(202109))), 
                           "year"),
    is_alive = factor(if_else(is.na(deathYear), "Alive", "Dead"))
  ) %>%
  filter(is_alive == "Dead", all_ages < 25) %>%
  select(nameFirst, nameLast, birthDate, deathDate, finalGameYear, all_ages) %>%
  arrange(all_ages)
```

Otherwise, the implied ages look reasonable.

```{r}
person_2 %>% 
  mutate(
    all_ages = time_length(interval(birthDate, coalesce(deathDate, ym(202109))), 
                           "year"),
    is_alive = factor(if_else(is.na(deathYear), "Alive", "Dead"))
  ) %>%
  ggplot(aes(x = all_ages, fill = is_alive)) + 
  geom_density(alpha = .4, color = "gray40") +
  theme_light() +
  theme(legend.position = "top") +
  labs(title = "Data set age distribution.",
       x = "Age at death, or at end of 2021 (if alive)", fill = NULL)
```

The Authors defined several variables from the player attributes.

* `cohort` = Period of MLB debut, Early (1902–1945), Golden (1946–1968), and Modern (1969–2004).
* `height_fct` = <6 feet, >=6 feet.
* `bmi_fct` = Normal (18.5 - <25.0), Overweight (25.0 – <30.0), Obese Class I (30.0 – <35.0)
* `career_length_fct` = <10 years, 10+ years
* `throws` = Right Handed, Left Handed

```{r}
person_3 <- person_2 %>%
  mutate(
    cohort = factor(
      case_when(between(debutYear, 1902, 1945) ~ "Early (1902–1945)",
                between(debutYear, 1946, 1968) ~ "Golden (1946–1968)",
                debutYear >= 1969 ~ "Modern (1969+)"),
      levels = c("Early (1902–1945)", "Golden (1946–1968)", "Modern (1969+)")
    ),
    height_fct = factor(
      if_else(height >= 72, ">=6 feet", "<6 feet"), 
      levels = c("<6 feet", ">=6 feet")
    ),
    bmi = weight / height^2 * 703,
    bmi_fct = factor(case_when(
      bmi < 18.5 ~ "Underweight (<18.5)",
      bmi >= 18.5 & bmi < 25.0 ~ "Normal (18.5 - <25.0)",
      bmi >= 25.0 & bmi < 30.0 ~ "Overweight (25.0 – <30.0)",
      bmi >= 30.0 & bmi < 35.0 ~ "Obese Class I (30.0 – <35.0)",
      bmi >= 35.0 & bmi < 40.0 ~ "Obese Class II (35.0 - <40.0)",
      bmi >= 40.0 & bmi < 44.9 ~ "Obese Class III (40.0 - <45.0"),
      levels =  c("Underweight (<18.5)",
                  "Normal (18.5 - <25.0)", 
                  "Overweight (25.0 – <30.0)",
                  "Obese Class I (30.0 – <35.0)", 
                  "Obese Class II (35.0 - <40.0)",
                  "Obese Class III (40.0 - <45.0")
    ),
    career_length_fct = factor(
      if_else(career_length < 10, "<10 years", "10+ years"),
      levels = c("<10 years", "10+ years")
    ),
    throws = factor(
      throws, 
      levels = c("R", "L"), 
      labels = c("Right Handed", "Left Handed")
    )
  )
```

The BMI bins in my data include values outside the range of the Authors' study and row counts are so low for some that it is advisable to lump some levels. I'm also unable to calculate the BMI for 55 players due to a missing height and/or weight. 

```{r}
person_3 %>% count(bmi_fct)
```

There are other missing values too. `height_fct` and `throws` have a few NAs.

```{r}
person_3 %>%
  select(height_fct, throws) %>%
  summary()
```

For `bmi_fct`, I'll expand Normal to include the one underweight fellow, and Obese Class I to include the 7 Class II and 1 Class III players. As for what to do with the 55 players of Unknown BMI, I'll use Multivariate Imputations by Chained Equations (MICE) to impute values. I'll use it to classify height and throws too.

```{r}
set.seed(2020)

mice_0 <- person_3 %>%
  select(birthCountry, weight, height, throws, bmi, debutYear, career_length, cohort) %>%
  mice::mice(method = "rf", printFlag = FALSE) %>%
  mice::complete()

person <- data.frame(person_3, 
                     bmi_mice = mice_0$bmi,
                     height_mice = mice_0$height,
                     throws_mice = mice_0$throws) %>%
  mutate(
    bmi_fct_2 = case_when(
      bmi_mice < 18.5 ~ "Underweight (<18.5)",
      bmi_mice >= 18.5 & bmi_mice < 25.0 ~ "Normal (18.5 - <25.0)",
      bmi_mice >= 25.0 & bmi_mice < 30.0 ~ "Overweight (25.0 – <30.0)",
      bmi_mice >= 30.0 & bmi_mice < 35.0 ~ "Obese Class I (30.0 – <35.0)",
      bmi_mice >= 35.0 & bmi_mice < 40.0 ~ "Obese Class II (35.0 - <40.0)",
      bmi_mice >= 40.0 & bmi_mice < 44.9 ~ "Obese Class III (40.0 - <45.0"
    ),
    bmi_fct_2 = fct_recode(
      bmi_fct_2, 
      `Normal (18.5 - <25.0)` = "Underweight (<18.5)",
      `Obese Class I (30.0 – <35.0)` = "Obese Class II (35.0 - <40.0)",
      `Obese Class I (30.0 – <35.0)` = "Obese Class III (40.0 - <45.0"
    ),
    height_fct_2 = if_else(height_mice >= 72, ">=6 feet", "<6 feet"),
    throws_2 = throws_mice
  )

# 30 / 55 estimated as Normal weight.
person %>%  
  filter(is.na(bmi)) %>%
  group_by(bmi_fct_2) %>%
  summarize(
    .groups = "drop", 
    n = n(),
    min_bmi = min(bmi_mice), 
    mean_bmi = mean(bmi_mice), 
    max_bmi = max(bmi_mice)
  )

# 15 / 24 estimated as < 6'.
person %>%
  filter(is.na(height_fct)) %>%
  count(height_fct_2)

# 14 / 15 estimated as right-handed
person %>%
  filter(is.na(throws)) %>%
  count(throws_2)
```

MICE estimated a little more than half the missing BMIs would be in the Normal range, the rest Overweight. The new BMI distribution is more more aligned with the Authors, and is compatible with regression algorithms. It estimated 15 of 24 missing heights to be under 6 feet, and 14 of 15 missing handedness to be right-handed.

The authors report the highest recorded BMI was for Calvin Pickering (32.61). The Lahman database reports a bmi of 33.55 for Calvin, ranking him sixth heaviest among players debuting up to 2004. Dmitri Young topped the list. Dmitri is shorter and heavier than Calvin, and debuted two years earlier, so perhaps he put on a lot of weight over his career and Lahman's database captures the more recent value.

```{r}
person %>% 
  filter(debutYear <= 2004) %>%
  arrange(desc(bmi_mice)) %>% 
  head(10) %>%
  mutate(rank = row_number()) %>%
  select(rank, nameFirst, nameLast, debut, weight, height, bmi_mice, bmi_fct_2) %>%
  flextable::flextable() %>%
  flextable::autofit() %>%
  flextable::theme_vanilla() %>%
  flextable::bg(i = ~ nameLast == "Pickering", bg = "lightgoldenrod")
```

Not to be morbid, but it is interesting to consider the data updated through 2021. Calvin is way down the ranking at 22 now, and Dmitri Young has fallen to fourth. The highest BMI belongs to Alejandro Kirk at 40.3. His entry in [Baseball Reference](https://www.baseball-reference.com/players/k/kirkal01.shtml) lists him at 245 pounds while the Lahman database lists 265 pounds. Looking at photos, his weight does seem to vary. 

```{r}
person %>% 
  # filter(debutYear <= 2004) %>%
  arrange(desc(bmi_mice)) %>% 
  head(30) %>%
  mutate(rank = row_number()) %>%
  select(rank, nameFirst, nameLast, debut, weight, height, bmi_mice, bmi_fct_2) %>%
  flextable::flextable() %>%
  flextable::autofit() %>%
  flextable::theme_vanilla() %>%
  flextable::bg(i = ~ nameLast %in% c("Young", "Pickering"), bg = "lightgoldenrod")
```

From the tables above, and from common knowledge, BMI is likely to be associated with debut date. The plot below confirms that. BMIs began to increase in 1990 and peaked in 2014. Perhaps the BMIs are related to sports nutrition and performance enhancing substances.

```{r warning=FALSE, message=FALSE}
person %>%
  mutate(post2004 = if_else(debutYear > 2004, "Post-2004", "1902-2004")) %>%
  ggplot(aes(x = debut, y = bmi_mice)) +
  geom_point(aes(color = post2004), alpha = 0.2) +
  geom_smooth(color = "gray40") + 
  theme_light() +
  labs(title = "BMIs increased after 1990 and peaked in 2014.")
```

Discrete time models are fitted to a person-year data set, with one row per player per year from debut to year of death (or censor).

```{r}
person_year_0 <-
  expand.grid(
    playerID = unique(person$playerID), 
    # Years are through 2021 instead of 2004 so I can run analysis on updated
    # data. I'll filter on yr <= 2004 for reproduction of original analysis.
    yr = c(1902:2021)
  ) %>%
  inner_join(person, by = "playerID") %>%
  filter(debutYear <= yr, coalesce(deathYear, 9999) >= yr)
```

The Author's data set included 241,218 person-years for 1902 - 2004 (103 years) with 6,772 players and 3,030 deaths. I don't quite match, but I'm not far off considering I'm using a different data source. It may be worth noting that I have 55 more players and 37 more deaths, and I have *less* person-years. The smaller number of person-years may indicate that my data source identified deaths that the Authors' source was unaware of.

```{r collapse=TRUE}
# Person-Years: 241,218 (Authors) vs 239,678 (me). I have 1,540 less person-years.
person_year_0 %>% filter(yr <= 2004) %>% nrow()

# Distinct Players: 6,772 (Authors) vs 6,827 (me). I have 55 more players.
person_year_0 %>% filter(yr <= 2004) %>% pull(playerID) %>% n_distinct()

# Death Events: 3,030 (Authors) vs 3,067 (me). I have 37 more deaths.
person_year_0 %>% filter(deathYear <= 2004) %>% pull(playerID) %>% n_distinct()
```

## Variables

The Authors define a few other variables for their regression analysis.

* `age` = number of years between date of birth and Jan 1 of year.
* `age_bin` = five-year age groups from 20-24 to 85+.
* `period_bin` = pre-1910, ten-year intervals from 1910 to 1970, and 1970-2004.
* `status` = 0 alive/censored, 1 dead

```{r}
person_year <- person_year_0 %>%
  mutate(
    age = time_length(interval(birthDate, ymd(paste0(yr, "0101"))), "years"),
    age_bin = cut(
      age, 
      breaks = c(0, 20 + 5 * (1:13), Inf), 
      dig.lab = 4, 
      right = FALSE
    ),
    period_bin = cut(yr, breaks = c(0, 1900 + 10 * (1:7), Inf), dig.lab = 4, 
                      right = FALSE),
    status = if_else(deathYear == yr, 1L, 0L)
  )
```

Here is a summary of the finalized data set.

```{r}
skimr::skim(person_year)
```

Table 1 presents the descriptive statistics of the covariates based on the pooled person-years. It is directly comparable to the Authors' [Table 1](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2743321/table/T1/) (external). Both data sets have the most person-years at age group [30, 35), but my data set has more person-years for younger people, aged < 45 years. I also have relatively more person-year records for the periods before 1940 and the Early (1902 - 1945) debut year cohort. Consistent with the original study, 41 percent of players-years are classified as overweight and .3 percent are obese. 54 percent are less than six feet tall (54.81 in Onge et al), and 86 percent are right-handed. 26 percent of players played 10 years or more (23.54 in Onge et al). I do not have career rating or first-year rating measures in my data set.

```{r}
t1 <- person_year %>%
  filter(yr <= 2004) %>%
  tbl_summary(
    label = list(
      age_bin ~ "Age Group",
      period_bin ~ "Time Period",
      cohort ~ "Cohort",
      bmi_fct ~ "Body Mass Index",
      height_fct ~ "Height",
      throws ~ "Handedness",
      career_length_fct = "Seasons Played",
      status = "Died"
    ),
    include = c(age_bin, period_bin, cohort, height_fct, bmi_fct, 
                career_length_fct, throws, status)
  ) 

t2 <- person_year %>%
  filter(yr <= 2004) %>%
  replace_na(list(status = 0)) %>%
  group_by(playerID, cohort, bmi_fct, height_fct, throws, career_length_fct) %>%
  summarize(.groups = "drop", status = max(status)) %>%
  tbl_summary(
    label = list(
      cohort ~ "Cohort",
      bmi_fct ~ "Body Mass Index",
      height_fct ~ "Height",
      throws ~ "Handedness",
      career_length_fct = "Seasons Played",
      status = "Died"
    ),
    include = c(cohort, height_fct, bmi_fct, 
                career_length_fct, throws, status)
  )

gtsummary::tbl_merge(list(t1, t2), tab_spanner = c("Person-Years", "Distinct Persons")) %>%
  gtsummary::as_flex_table() %>% 
  flextable::theme_vanilla() %>%
  flextable::bg(i = ~ is.na(stat_0_1), bg = "gray80") %>%
  flextable::set_caption("Table 1. Percentage of selected characteristics, MLB players, 1902-2004.")
```

My Age Group distribution has many more records at the lowest bin, [0,25), `r gtsummary::inline_text(t1, variable = age_bin, level = "[0,25)")`, compared to 4.23% for the Authors. I have only `r gtsummary::inline_text(t1, variable = age_bin, level = "[85,Inf)")` records in the highest bin, [85,Inf) while the Authors have 1.11%.

I added a second column to Table 1 showing distinct player characteristics. It is evident that there are more records associated with earlier players. For example, while `r gtsummary::inline_text(t2, variable = cohort, level = "Early (1902–1945)")` of players debuted between 1902 and 1945 (Early cohort), they comprise `r gtsummary::inline_text(t1, variable = cohort, level = "Early (1902–1945)")` of the player-year rows.

## Method

Saint Onge et al. ([2008](#SaintOnge2008)) uses logistic regression to estimate a discrete time hazards model for risk of death between the debut date and the end of the follow-up period. They explain that they start with debut date rather than birth date because by definition all players have survived until their debut. The advantage of using a discrete time hazards model over a Cox proportional hazards model is that enables the calculation of life tables with the covariate estimates.

A discrete time logistic regression can be fit with either logit link function or a complementary log-log link function. My [supervised maching learning notes](https://bookdown.org/mpfoley1973/supervised-ml/survival-analysis.html#discrete-time) compare the link functions. The logit link models the hazard odds ratio, and the complementary log-log link models the hazard ratio. The complementary log-log link is directly comparable to a Cox proportional hazards model. I'm not sure which link function the Authors used. I tried both, and achieved very similar coefficient measures. The settled on the complementary log-log link.

```{r}
person_year_2004 <- person_year %>% filter(yr <= 2004)

mdl_1 <- glm(status ~ age_bin, 
             data = person_year_2004, family = binomial(link = "cloglog"))
mdl_2 <- glm(status ~ age_bin + period_bin, 
             data = person_year_2004, family = binomial(link = "cloglog"))
mdl_3 <- glm(status ~ age_bin + period_bin + cohort, 
             data = person_year_2004, family = binomial(link = "cloglog"))
mdl_4 <- glm(status ~ age_bin + period_bin + bmi_fct_2, 
             data = person_year_2004, family = binomial(link = "cloglog"))
mdl_5 <- glm(status ~ age_bin + period_bin + height_fct_2, 
             data = person_year_2004, family = binomial(link = "cloglog"))
mdl_6 <- glm(status ~ age_bin + period_bin + throws_2, 
             data = person_year_2004, family = binomial(link = "cloglog"))
# not mdl_7 or mdl_8 because I do not have player ratings.
mdl_9 <- glm(status ~ age_bin + period_bin + career_length_fct, 
             data = person_year_2004, family = binomial(link = "cloglog"))
```

# Results

Table 2 presents the model coefficient estimates for each model. Models 7 and 8 are missing because I do not have the player ratings to fit them. Table is is directly comparable to the Authors' [Table 2](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2743321/table/T2/) (external). 

```{r}
astercize <- function(e, p) {
  aster_p <- case_when(
    p < .001 ~ "***",
    p < .01 ~ "**",
    p < .05 ~ "*",
    TRUE ~ ""
  )
  paste0(e, aster_p)
}

bind_rows(
  `Model 1` = tidy(mdl_1, exponentiate = FALSE),
  `Model 2` = tidy(mdl_2, exponentiate = FALSE),
  `Model 3` = tidy(mdl_3, exponentiate = FALSE),
  `Model 4` = tidy(mdl_4, exponentiate = FALSE),
  `Model 5` = tidy(mdl_5, exponentiate = FALSE),
  `Model 6` = tidy(mdl_6, exponentiate = FALSE),
  `Model 9` = tidy(mdl_9, exponentiate = FALSE),
  .id = "model_num"
) %>%
  mutate(lbl = map2_chr(scales::comma(estimate, .01), p.value, astercize)) %>%
  pivot_wider(id_cols = term, names_from = model_num, values_from = lbl) %>%
  flextable::flextable() %>%
  flextable::align(j = 2:8, align = "right") %>%
  flextable::theme_zebra() %>%
  flextable::autofit() %>%
  flextable::set_caption("Table 2. MLB hazard odds ratio coeficients on mortality, 1902 - 2004.")
```

Model 1 shows that the odds of death increase with age. Players aged 40–44 are exp(`r tidy(mdl_1, exponentiate = FALSE) %>% filter(term == "age_bin[40,45)") %>% pull(estimate) %>% comma(.01)`) = `r tidy(mdl_1, exponentiate = TRUE) %>% filter(term == "age_bin[40,45)") %>% pull(estimate) %>% comma(.01)` times as likely to die over the follow-up period as players aged 20–24 (Authors report exp(1.32) = 3.74), those aged 50–54 are exp(`r tidy(mdl_1, exponentiate = FALSE) %>% filter(term == "age_bin[50,55)") %>% pull(estimate) %>% comma(.01)`) = `r tidy(mdl_1, exponentiate = TRUE) %>% filter(term == "age_bin[50,55)") %>% pull(estimate) %>% comma(.01)` times as likely to die (Authors report exp(2.39) = 10.9), and players aged 70–74 are exp(`r tidy(mdl_1, exponentiate = FALSE) %>% filter(term == "age_bin[70,75)") %>% pull(estimate) %>% comma(.1)`) = `r tidy(mdl_1, exponentiate = TRUE) %>% filter(term == "age_bin[70,75)") %>% pull(estimate) %>% comma(.1)` times as likely to die (Authors report exp(4.00) = 54.6). 

Model 2 shows that, adjusting for age, more recent calendar periods are associated with lower risks of death. The greatest declines in mortality took place between the 1920–1929 and 1930–1939 periods, exp(`r tidy(mdl_2, exponentiate = FALSE) %>% filter(term == "period_bin[1920,1930)") %>% pull(estimate) %>% comma(.01)`) = `r tidy(mdl_2, exponentiate = TRUE) %>% filter(term == "period_bin[1920,1930)") %>% pull(estimate) %>% comma(.01)` to exp(`r tidy(mdl_2, exponentiate = FALSE) %>% filter(term == "period_bin[1930,1940)") %>% pull(estimate) %>% comma(.01)`) = `r tidy(mdl_2, exponentiate = TRUE) %>% filter(term == "period_bin[1930,1940)") %>% pull(estimate) %>% comma(.01)` (Authors report exp(-.54) = 0.58 to exp(-1.08) = 0.34), and between the 1960–1969 and 1970–2004 periods, exp(`r tidy(mdl_2, exponentiate = FALSE) %>% filter(term == "period_bin[1960,1970)") %>% pull(estimate) %>% comma(.01)`) = `r tidy(mdl_2, exponentiate = TRUE) %>% filter(term == "period_bin[1960,1970)") %>% pull(estimate) %>% comma(.01)` to exp(`r tidy(mdl_2, exponentiate = FALSE) %>% filter(term == "period_bin[1970,Inf)") %>% pull(estimate) %>% comma(.01)`) = `r tidy(mdl_2, exponentiate = TRUE) %>% filter(term == "period_bin[1970,Inf)") %>% pull(estimate) %>% comma(.01)`) (Authors report exp(-1.47) = 0.23 to exp(-1.97) = 0.14). 

The Authors' Model 3 shows that the coefficients for period and age are reduced but remain strong predictors of mortality after adjusting for the cohort of debut. However my fit shows that the Modern debut era is significantly *positively* associated with mortality risk, exp(`r tidy(mdl_3, exponentiate = FALSE) %>% filter(term == "cohortModern (1969+)") %>% pull(estimate) %>% comma(.01)`) = `r tidy(mdl_3, exponentiate = TRUE) %>% filter(term == "cohortModern (1969+)") %>% pull(estimate) %>% comma(.01)` while the period predictors are more *magnified*. I attribute this to the fact that the debut era is positively correlated with the period bins.

```{r}
person_year_2004 %>%
  count(period_bin, cohort) %>%
  ggplot(aes(x = period_bin, y = n, fill = cohort)) +
  geom_col() +
  theme_light() + 
  theme(axis.text.x = element_text(angle = 90)) +
  labs(y = "player-years", fill = NULL, 
       title = "Period and Cohort (Debut Era) Association")
```

Model 4 shows that obese class 1 players are exp(`r tidy(mdl_4, exponentiate = FALSE) %>% filter(term == "bmi_fctObese Class I (30.0 – <35.0)") %>% pull(estimate) %>% comma(.01)`) = `r tidy(mdl_4, exponentiate = TRUE) %>% filter(term == "bmi_fctObese Class I (30.0 – <35.0)") %>% pull(estimate) %>% comma(.01)` times as likely to die as players of normal weight (Authors report exp(.57) = 1.77). The effect was not significant at the .05 level, but it reduced the magnitude of the period bins.

Similarly, model 5 shows players over six feet have a slight increase in mortality risk, `r tidy(mdl_5, exponentiate = TRUE) %>% filter(term == "height_fct>=6 feet") %>% pull(estimate) %>% comma(.1)` (exp(0.08)), but that relationship was not significant in Saint Onge et al. Left-handedness showed nearly zero effect and was not significant in either my model 6 or in Saint Onge et al.

Finally, those who play for 10 or more years have `r tidy(mdl_9, exponentiate = TRUE) %>% filter(term == "career_length_fct10+ years") %>% mutate(lwr = (1 - estimate) * 100) %>% pull(lwr) %>% comma(1)`) percent lower odds of death ((1 - exp(-.13)) * 100) over the follow-up period than those who have shorter careers (Model 9). Saint Onge et al reported a 14 percent lower odds.

Table 3 presents player life expectancy for the most recent period, 1970-2004, based on the hazard coefficients from model 2. Table 3 is directly comparable to [Table 3](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2743321/table/T3/) of Saint Onge et al. I didn't quite figure out how to reproduce it, but followed the methodology presented by [Measure Evaluation](https://www.measureevaluation.org/resources/training/online-courses-and-resources/non-certificate-courses-and-mini-tutorials/population-analysis-for-planners/lesson-7.html) with further explanation from [page 442](https://www.google.com/books/edition/_/DRpWZlKIqwoC?hl=en&gbpv=1&bsq=central%20death%20rate) of **The Methods and Materials of Demography** (Shryock, et al, [1980](#Shryock1980)). Some notes on column definitions:

* **mx** is the age-specific central death rate, $m_x = 1 / (1 + e^{-z})$ where *z* is sum of the model coefficients from model 2 for period 1970 - 2004: intercept = `r coef(mdl_2)["(Intercept)"] %>% comma(.01)`, period 1970 - 2004 = `r coef(mdl_2)["period_bin[1970,Inf)"] %>% comma(.01)` and beta = [value from age group]. E.g., $m_{25-30}$ = `r comma(1 / (1 + exp(-(coef(mdl_2)["(Intercept)"] + coef(mdl_2)["period_bin[1970,Inf)"] + coef(mdl_2)["age_bin[25,30)"]))), .0001)`, or  $1 / (1 + e^{-(`r coef(mdl_2)["(Intercept)"] %>% comma(.01)` + `r coef(mdl_2)["period_bin[1970,Inf)"] %>% comma(.01)` + `r coef(mdl_2)["age_bin[25,30)"] %>% comma(.01)`)})$.
* **nQx** is the five-year mortality rate, given by $\frac{5 \cdot m_x}{1 + g_x m_x}$ where $g_x$ is a factor measuring the average number of years lived within the age group and is initially assumed by be 2.5 years. This is from equation 25 in Shryock et al ([1980](#Shryock1980)]).
* **1 - nQx** is the complement of nQx, an intermediate calc. It is the five-year survival rate.
* **cum(.)** is the cumulative product of 1 - nQx. Whereas 1 - nQx is an instantaneous probability, cum(.) is a cumulative probability. It is the probability of living to that age, then living another five years.
* **lx** is the number of persons alive at the beginning of the age interval. It equals the prior cum(.) * 100,000. The 100,000 normalizes the presentation to a hypothetical population of 100,000.
* **ndx** is the number of persons dying during the age interval, lx * nQx.
* **Lx** is the number of person-years in the age interval, (lx - ndx) * 5. It is the average population size.
* **Tx** is the cumulative sum of Lx, moving from bottom to top. It is the total number of person-years that would be lived for the age cohort if the cohort were to progress through the remainder of the life table.
* **ex** is the average remaining life time, Tx / lx.

```{r}
tdy_2 <- mdl_2 %>% broom::tidy()

life_tbl_period <- tibble(
  age_bin = rep(levels(person_year$age_bin), 8),
  age_bin_term = paste0("age_bin", age_bin),
  period_bin = map(levels(person_year$period_bin), ~rep(.x, 14)) %>% unlist(),
  period_bin_term = paste0("period_bin", period_bin),
  intercept = coef(mdl_2)["(Intercept)"],
  # period_bin_1970_Inf = coef(mdl_2)["period_bin[1970,Inf)"],
  us_male_e = rep(c(53.25, 48.67, 44.10, 39.57, 35.09, 30.66, 26.37, 22.30, 18.53, 
                 15.12, 12.05, 9.39, 7.12, 5.31), 8)
) %>%
  left_join(tdy_2 %>% select(age_bin_term = term, age_bin_est = estimate), 
            by = "age_bin_term") %>%
  left_join(tdy_2 %>% select(period_bin_term = term, period_bin_est = estimate), 
            by = "period_bin_term") %>%
  replace_na(list(age_bin_est = 0, period_bin_est = 0)) %>%
  group_by(period_bin) %>%
  mutate(
    mx = 1 / (1 + exp(-(intercept + period_bin_est + age_bin_est))),
    nQx = (5 * mx) / (1 + 2.5 * mx),
    nQx_comp = 1 - nQx,
    nQx_cumprod = nQx_comp * lag(nQx_comp, n = 1, default = 1.0),
    lx = 100000 * lag(nQx_cumprod, n = 1, default = 1.0),
    ndx = lx * nQx,
    Lx = (lx - ndx) * 5
  ) %>%
  arrange(period_bin, desc(age_bin)) %>%
  mutate(
    Tx = cumsum(Lx),
    ex = Tx / lx
  ) %>%
  ungroup() %>%
  arrange(period_bin, age_bin) %>%
  select(period_bin, age_bin, intercept, age_bin_est, period_bin_est, mx:ex, us_male_e)

life_flex <- function(dat) {
  dat %>%
    select(-c(intercept, age_bin_est, period_bin_est)) %>%
    flextable::flextable() %>%
    flextable::set_header_labels(
      age_bin = "Age Group",
      # age_bin_est = "Beta",
      nQx_comp = "1 - nQx",
      nQx_cumprod = "cum(.)",
      us_male_e = "U.S. Males"
    ) %>%
    flextable::colformat_double(j = c(2:5), digits = 4) %>%
    flextable::colformat_double(j = c(6:9), digits = 0, big.mark = ",") %>%
    flextable::colformat_double(j = c(10:11), digits = 1) %>%
    flextable::theme_zebra()
}

life_tbl_period %>%
  filter(period_bin == "[1970,Inf)") %>%
  select(-period_bin) %>%
  life_flex()
```

Column U.S. Males is taken directly from Saint Onge et al. Table 3 in Saint Onge et al shows that players have higher life expectancies than the general U.S. male population at all ages, but the advantage diminishes with age. 20-year-old MLB players can expect to live 58.1 additional years in the period 1970 - 2004 compared to 53.3 for comparable males in the U.S. population. My Table 3 show a more modest advantage. A 20-year-old MLB player can expect to live 54.9 additional years, 1.7 more than comparable males in the U.S. population (compare to 4.8 in Saint Onge et al). The advantage diminishes, then becomes a disadvantage for 60-65 year old MLB players.

Figure 1 illustrates life expectancies for calendar periods (Panel A) calculated from Model 2 in Table 2 and cohorts (Panel B) from Model 3^[Saint Onge et al say both panels are from Model 2, but that cannot be right. Cohort is not a predictor variable in Model 2.]. It is directly comparable to Figure 1 Panel A in Saint Onge et al. It shows that each period ushers in higher life expectancies for each cohort. Life expectancies at age 20 were `r life_tbl_period %>% filter(age_bin == "[0,25)", period_bin == "[1910,1920)") %>% pull(ex) %>% comma(.1)` years (45.7 in Saint Onge et al) among those alive between 1910 and 1919, `r life_tbl_period %>% filter(age_bin == "[0,25)", period_bin == "[1930,1940)") %>% pull(ex) %>% comma(.1)` years (53.6 years in Saint Onge et al) among those alive between 1930 and 1939, `r life_tbl_period %>% filter(age_bin == "[0,25)", period_bin == "[1950,1960)") %>% pull(ex) %>% comma(.1)` years (56.3 years in Saint Onge et al) among those alive between 1950 and 1959, and `r life_tbl_period %>% filter(age_bin == "[0,25)", period_bin == "[1970,Inf)") %>% pull(ex) %>% comma(.1)` years (59.6 years in Saint Onge et al) among those alive between 1970 and 2004. Panel B show life expectancies by debut era. In Saint Onge et al, players from the Modern Era can expect to live 65.5 years, compared to 52.4 years from the Early Era and 58.3 from the Golden Era. My Panel B does not show that, I think because of the collinearity between era and time period in the model.

```{r}
# Panel B is constructed from the life table derived from model 3. Repeat the 
# process.
tdy_3 <- mdl_3 %>% broom::tidy()

life_tbl_cohort <- tibble(
  age_bin = rep(levels(person_year$age_bin), 3),
  age_bin_term = paste0("age_bin", age_bin),
  cohort = map(levels(person_year$cohort), ~rep(.x, 14)) %>% unlist(),
  cohort_term = paste0("cohort", cohort),
  intercept = coef(mdl_3)["(Intercept)"],
  us_male_e = rep(c(53.25, 48.67, 44.10, 39.57, 35.09, 30.66, 26.37, 22.30, 18.53, 
                 15.12, 12.05, 9.39, 7.12, 5.31), 3)
) %>%
  left_join(tdy_3 %>% select(age_bin_term = term, age_bin_est = estimate), 
            by = "age_bin_term") %>%
  left_join(tdy_3 %>% select(cohort_term = term, cohort_est = estimate), 
            by = "cohort_term") %>%
  replace_na(list(age_bin_est = 0, cohort_est = 0)) %>%
  group_by(cohort) %>%
  mutate(
    mx = 1 / (1 + exp(-(intercept + cohort_est + age_bin_est))),
    nQx = (5 * mx) / (1 + 2.5 * mx),
    nQx_comp = 1 - nQx,
    nQx_cumprod = nQx_comp * lag(nQx_comp, n = 1, default = 1.0),
    lx = 100000 * lag(nQx_cumprod, n = 1, default = 1.0),
    ndx = lx * nQx,
    Lx = (lx - ndx) * 5
  ) %>%
  arrange(cohort, desc(age_bin)) %>%
  mutate(
    Tx = cumsum(Lx),
    ex = Tx / lx
  ) %>%
  ungroup() %>%
  arrange(cohort, age_bin) %>%
  select(cohort, age_bin, intercept, age_bin_est, cohort_est, mx:ex, us_male_e)
```

```{r}
fig1a <- life_tbl_period %>%
  filter(period_bin %in% c("[1910,1920)", "[1930,1940)", "[1950,1960)", "[1970,Inf)")) %>%
  ggplot(aes(x = age_bin, y = ex, group = period_bin, color = fct_rev(period_bin))) +
  geom_line() +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(subtitle = "A. Period", color = NULL, x = "Age", y = "e(x)")

fig1b <- life_tbl_cohort %>%
  # filter(period_bin %in% c("[1910,1920)", "[1930,1940)", "[1950,1960)", "[1970,Inf)")) %>%
  ggplot(aes(x = age_bin, y = ex, group = cohort, color = fct_rev(cohort))) +
  geom_line() +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(subtitle = "B. Cohort", color = NULL, x = "Age", y = "e(x)")

library(patchwork)
fig1a / fig1b +
  patchwork::plot_annotation(title = "Figure 1.")
```

# 2022 Update

At the time of this analysis, the Lahman R package data source has player debuts through `r format(max(person_year$debut), "%b %Y")`.

```{r}
mdl_1_2022 <- glm(status ~ age_bin, 
             data = person_year, family = binomial(link = "cloglog"))
mdl_2_2022 <- glm(status ~ age_bin + period_bin, 
             data = person_year, family = binomial(link = "cloglog"))
mdl_3_2022 <- glm(status ~ age_bin + period_bin + cohort, 
             data = person_year, family = binomial(link = "cloglog"))
mdl_4_2022 <- glm(status ~ age_bin + period_bin + bmi_fct, 
             data = person_year, family = binomial(link = "cloglog"))
mdl_5_2022 <- glm(status ~ age_bin + period_bin + height_fct, 
             data = person_year, family = binomial(link = "cloglog"))
mdl_6_2022 <- glm(status ~ age_bin + period_bin + throws, 
             data = person_year, family = binomial(link = "cloglog"))
# not mdl_7 or mdl_8 because I do not have player ratings.
mdl_9_2022 <- glm(status ~ age_bin + period_bin + career_length_fct, 
             data = person_year, family = binomial(link = "cloglog"))

bind_rows(
  `Model 1` = tidy(mdl_1_2022, exponentiate = FALSE),
  `Model 2` = tidy(mdl_2_2022, exponentiate = FALSE),
  `Model 3` = tidy(mdl_3_2022, exponentiate = FALSE),
  `Model 4` = tidy(mdl_4_2022, exponentiate = FALSE),
  `Model 5` = tidy(mdl_5_2022, exponentiate = FALSE),
  `Model 6` = tidy(mdl_6_2022, exponentiate = FALSE),
  `Model 9` = tidy(mdl_9_2022, exponentiate = FALSE),
  .id = "model_num"
) %>%
  mutate(lbl = map2_chr(scales::comma(estimate, .01), p.value, astercize)) %>%
  pivot_wider(id_cols = term, names_from = model_num, values_from = lbl) %>%
  flextable::flextable() %>%
  flextable::align(j = 2:8, align = "right") %>%
  flextable::theme_zebra() %>%
  flextable::autofit() %>%
  flextable::set_caption("Table 4. MLB hazard odds ratio coeficients on mortality, 1902 - 2021.")
```

# Cox Proportional Hazards

The Authors chose logistic regression model because it is compatible with life table development.
For comparison, I will fit equivalent Cox proportional hazards models.

```{r}
cox_dat <- person %>%
  mutate(
    time = time_length(interval(birthDate, 
                                coalesce(deathDate, max(person$finalGame, na.rm = TRUE))), 
                       unit = "year"),
    status = if_else(is.na(deathDate), 1, 2)
  )
coxph(Surv(time, status) ~ cohort, data = cox_dat)
```

# References

[Overview of Life Tables and Survival Rates](https://www.measureevaluation.org/resources/training/online-courses-and-resources/non-certificate-courses-and-mini-tutorials/population-analysis-for-planners/lesson-7.html). Lesson 7 of Population Analysis for Planners. Measure Evaluation.

<a id="Lahman"></a>Lahman. Sean Lahman's R Package, version 10.0-1, 2022-04-07. [GitHub](https://github.com/cdalzell/Lahman)

<a id="SaintOnge2008"></a>Saint Onge JM, Rogers RG, Krueger PM. Major League Baseball Players' Life Expectancies. Soc Sci Q. 2008;89(3):817-830. doi:10.1111/j.1540-6237.2008.00562.x. [HTML](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2743321/).

<a id="Shryock1980"></a>Shryock HS, Siegel JS, Larmon EA, (1980).The Methods and Materials of Demography. United States:Department of Commerce, Bureau of the Census. [Google Books](https://www.google.com/books/edition/_/DRpWZlKIqwoC?hl=en&gbpv=0).

<a id="TotalBaseball"></a>Thorn, J., & Palmer, P. (1990). Total baseball (p. 2294). Haynes Publications. [Google Scholar](https://scholar.google.com/scholar_lookup?title=Total+Baseball&publication_year=2004&).
